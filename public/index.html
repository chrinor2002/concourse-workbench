<!DOCTYPE html>
<html>
	<head>
		<title>Concourse Workbench</title>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular-cookies.min.js"></script>

		<link href="/c/public/main.css" media="all" rel="stylesheet" type="text/css">
		<link href="/css/clearfix.css" media="all" rel="stylesheet" type="text/css">
		<link id="favicon" rel="icon" type="image/png" href="/c/public/images/favicon.png" />

		<style>
			.content-frame {
				padding-top: 1.5em;
			}
			.pipe-wrapper {
				line-height: 1.5em;
				float: left;
				margin: 1.5em;
				width: 150px;
				height: 9em; /* 1.5 * 4 + 1.5 + 1.5 */
			}
			.pipe {
				display: block;
				position: relative;
				width: 100%;
				height: auto;
				max-height: 9em; /* 1.5 * 4 + 1.5 + 1.5 */
			}
			.pipe .js-animation-wrapper {
				height: 100%;
				width: 100%;
				position: absolute;
				top: 0;
				left: 0;
			}
			.pipe .animation-medium {
				height: 100%;
				width: 100%;
			}
			.pipe.paused {
				opacity: 0.5;
			}
			.pipe .job {
				height: 5px;
				margin-bottom: 1px;
				width: 100%;
			}
			.pipe .text {
				padding: 1.5em;
			}
			.sidebar .filters {
				padding: 1em;
				text-align: left;
			}
			.sidebar .filters .filter{
				padding: 0.25em;
			}
			.sidebar .filters .filter:first-child{
				padding-top: 0;
			}

			#status-graph-top-bar {
				z-index: 110;
				position: fixed;
				top: 0;
				right: 20%;
				left: 20%;
				height: 40px;
			}
			#status-graph-top-bar .btn-hamburger {
				width: 5%;
				padding-left: 0;
				padding-right: 0;
				float: left;
				cursor: auto;
				text-align: center;
			}
			#status-graph-top-bar table {
				width: 90%;
				border-collapse: collapse;
				float: left;
			}
			#status-graph-top-bar table td {
				height: 40px;
			}
			#status-graph-top-bar table td.success:last-of-type {
				border: 1px solid blue;
			}
		</style>
	</head>
	<body ng-app="concourseNATS" ng-controller="concourseNATS">
		<div class="content-frame">
			<div id="top-bar-app">
				<nav class="top-bar test">
					<ul class="groups">
						<li class="main">
							<span class="sidebar-toggle test btn-hamburger" aria-label="Toggle Filter" ng-click="sidebarToggle()">
								<i class="fa fa-filter"></i>
							</span>
						</li>
					</ul>
				</nav>
			</div>
			<div id="status-graph-top-bar">
				<span class="btn-hamburger"><i class="fa fa-heartbeat"></i></span>
				<table>
					<tr>
						<td ng-repeat="pipe in pipelines | filter: getPipeFilter() | orderByPipeStatus" ng-class="getPipeStatusClasses(pipe)" title="{{getPipeStatus(pipe)}}"></td>
					</tr>
				</table>
				<span class="btn-hamburger"><i class="fa fa-heartbeat"></i></span>
			</div>
			<div class="bottom">
				<div class="sidebar test" ng-class="{ sidebar: true, test: true, visible: sidebarVisible }">
					<ul class="team">
						<li>
							<div class="team-header">sort</div>
						</li>
						<li class="filters">
							<div class="filter">
								<label for="sortBy">Team:</label>
								<select id="sortBy" type="text" ng-model="pipeSortBy" ng-init="pipeSortBy = 'name'">
									<option value="">None</option>
									<option value="name">Name</option>
									<option value="aggregateStatus">Status</option>
								</select>
							</div>
						</li>
						<li>
							<div class="team-header">filters</div>
						</li>
						<li class="filters">
							<div class="filter">
								<label for="filterTeamName">Team:</label>
								<input id="filterTeamName" type="text" ng-model="filter.team_name">
							</div>
							<div class="filter">
								<label for="filterName">Name:</label>
								<input id="filterName" type="text" ng-model="filter.name">
							</div>
							<div class="filter">
								<label for="filterPaused">Paused:</label>
								<input id="filterPaused" type="checkbox" ng-model="filter.paused">
							</div>
							<div class="filter">
								<label for="filterPublic">Public:</label>
								<input id="filterPublic" type="checkbox" ng-model="filter.public" ng-init="filter.public = true">
							</div>
							<div class="filter">
								<label>Job Status:</label><br/>

								<input id="filterAggregateStatusAny" type="radio" ng-model="filter.aggregateStatus" value="">
								<label for="filterAggregateStatusAny">Any</label><br/>
								<input id="filterAggregateStatusFailed" type="radio" ng-model="filter.aggregateStatus" value="failed">
								<label for="filterAggregateStatusFailed">Failed</label><br/>
								<input id="filterAggregateStatusErrored" type="radio" ng-model="filter.aggregateStatus" value="errored">
								<label for="filterAggregateStatusErrored">Errored</label><br/>
								<input id="filterAggregateStatusSucceeded" type="radio" ng-model="filter.aggregateStatus" value="succeeded">
								<label for="filterAggregateStatusSucceeded">Succeeded</label><br/>
								<input id="filterAggregateStatusNoBuilds" type="radio" ng-model="filter.aggregateStatus" value="no-builds">
								<label for="filterAggregateStatusNoBuilds">No-Builds</label><br/>
								<input id="filterAggregateStatusPending" type="radio" ng-model="filter.aggregateStatus" value="pending">
								<label for="filterAggregateStatusPending">Pending</label><br/>
								<input id="filterAggregateStatusStarted" type="radio" ng-model="filter.aggregateStatus" value="started">
								<label for="filterAggregateStatusStarted">Started</label><br/>
							</div>
						</li>
					</ul>
				</div>
				<div id="content">
					<div class="pipes clearfix">
						<div ng-repeat="pipe in pipelines | filter: getPipeFilter() | orderBy:['paused', pipeSortBy]" class="pipe-wrapper">
							<a my-pipeline href="/r/{{ pipe.url }}" class="pipe" ng-class="getPipeClasses(pipe)"></a>
						</div>
					</div>
				</div>
			</div>
		</div>
	<script>

    var app = angular.module('concourseNATS', ['ngCookies']);
	app.run(function($rootScope) {
		$rootScope.keys = Object.keys;
	});
	app.directive('myPipeline', function() {
		return {
			templateUrl: 'myPipeline.html'
		};
	});
	app.filter('orderByPipeStatus', function () {

		function pipeStatusNumber(pipe) {
			if (pipe.paused) {
				return 100;
			}
			var status = {
				'succeeded': 1,
				'failed': 2,
				'errored': 3,
				'no-builds': 9
			};
			return status[pipe.aggregateStatus];
		}

		return function (items, field) {
			var filtered = [];
			angular.forEach(items, function(item) {
				filtered.push(item);
			});
			filtered.sort(function (a, b) {    
				return (pipeStatusNumber(a) > pipeStatusNumber(b) ? 1 : -1);
			});
			return filtered;
		};
	});
    app.controller('concourseNATS', function($scope, $window, $http, $cookies) {

		$scope.sidebarToggle = function() {
			$scope.sidebarVisible = !!!$scope.sidebarVisible;
		}

		$scope.getPipeStatus = function(pipe) {
			return pipe.paused ? 'paused' : pipe.aggregateStatus
		}

		$scope.getPipeClasses = function(pipe) {
			var classes = $scope.getPipeStatusClasses(pipe);
			return angular.extend(classes, {
				pipe: true,
				'job-animation-node': true
			});
		}

		$scope.getPipeStatusClasses = function(pipe) {
			return {
				'no-builds': pipe && pipe.aggregateStatus == 'no-builds',
				succeeded: pipe && pipe.aggregateStatus == 'succeeded',
				failed: pipe && pipe.aggregateStatus == 'failed',
				errored: pipe && pipe.aggregateStatus == 'errored',
				pending: pipe && pipe.pending == 'pending',
				started: pipe && pipe.pending == 'started',
				paused: pipe && pipe.paused
			};
		}

		var filter = $cookies.getObject('filter');
		if (!filter) {
			filter = {};
		}
		$scope.filter = filter;
		$scope.$watch('filter', function(newValue, oldValue){
			// save the value to a cookie
			$cookies.putObject('filter', filter);
		}, true);
		$scope.getPipeFilter = function() {
			var filters = angular.extend({}, $scope.filter);
			if (filters.aggregateStatus === 'pending' || filters.aggregateStatus === 'started') {
				delete filters.aggregateStatus;
				filters.pending = $scope.filter.aggregateStatus;
			}

			return filters;
		}

		$scope.isFilterDisabled = function(filter) {
			var status = $scope.getPipeFilter().aggregateStatus;
			return status && status != filter;
		}

		$scope.getPipes = function() {
			$http({
				method: 'GET',
				url: '/c/api/v1/teams/main/pipelines'
			}).then(function(response) {
				$scope.setPipes(response.data);
			}, function(err) {
				console.error(err);
			});
		}

		// get and set the env
		$scope.getJSEnv = function() {
			$http({
				method: 'GET',
				url: '/e'
			}).then(function(response) {
				$scope.setJSEnv(response.data);
			}, function(err) {
				console.error(err);
			});
		}
		$scope.setJSEnv = function(jsenv) {
			$scope.jsenv = jsenv;
		}

		$scope.setPipes = function(pipes) {
			pipes.forEach(function(pipe, index) {
				pipes[index].aggregateStatus = 'no-builds';
			});

			var list = [];
			pipes.forEach(function(pipe, index) {
				if (!pipe.paused) {
					var promise = $http({
						method: 'GET',
						url: '/c/api/v1' + pipe.url + '/jobs'
					}).then(function(jobsResponse) {
						pipe.jobs = jobsResponse.data;
						var status = null;
						var pending = null;
						jobsResponse.data.forEach(function(job) {
							if (job.finished_build) {
								if (status === null) {
									status = job.finished_build.status;
								} else if(status === 'succeeded' && job.finished_build.status === 'failed') {
									status = job.finished_build.status;
								} else if(job.finished_build.status === 'errored') {
									status = job.finished_build.status;
								}
							}

							if (pending === null && job.next_build !== null) {
								pending = job.next_build.status;
							}
						});

						if (status !== null) {
							pipe.aggregateStatus = status;
						} else {
							pipe.aggregateStatus = 'no-builds';
						}
						pipe.pending = pending;

						return pipe;
					}, function(err) {
						console.error(err);
					});
					list.push(promise);
				} else {
					list.push(Promise.resolve(pipe));
				}
			});
			if ($scope.pipelines === null || $scope.pipelines === undefined) {
				$scope.pipelines = pipes;
			}
			Promise.all(list).then((pipes) => {
				$scope.pipelines = pipes;
			});
		}

		$scope.getPipes();
		$scope.getJSEnv();

		// setup auto refresh
		var refreshInterval;
		$scope.$watch('jsenv', function(newValue, oldValue) {
			var existingInteval = refreshInterval !== null && refreshInterval !== undefined;
			if (newValue && newValue.JS_INTERVAL > 0 && !existingInteval) {
				refreshInterval = setInterval($scope.getPipes, newValue.JS_INTERVAL);
			} else if (newValue && newValue.JS_INTERVAL > 0 && existingInteval) {
				clearInterval(existingInteval);
				refreshInterval = setInterval($scope.getPipes, newValue.JS_INTERVAL);
			} else if (existingInteval) {
				clearInterval(existingInteval);
				delete refreshInterval;
			}
		});
    });
    </script>
	</body>
</html>